# Project

# 💊 약통 무게 기반 복약 관리 + 의약품 지식 LLM + 처방약 OCR 스케줄러

**“약통 무게 + 의약품 지식 + OCR 인식으로 복약 관리 전 과정을 자동화”**

- 로드셀 센서로 **무게 기반 복용 여부 자동 판단**  
- **일반의약품 데이터 기반 LLM Q&A (OTC-QA)**  
- **처방전 사진 촬영 → OCR → 자동 스케줄 등록**  
- 미복용 시 **푸시 알림**, 기록은 **클라우드 저장/보호자 공유**  
- 노인, 어린이, 만성질환자 대상 **안전한 복약 관리 지원**

---

## ✅ 전체 아키텍처 구성

[약통 + 로드셀(HX711)]
↓ (Python + EWMA 필터)
[라즈베리파이: 무게 측정 + Django 전송]
↓
[Django 서버 (REST API)]
├─ AI 모듈 (복용 여부 판별, 미복용 확률 예측)
├─ OTC-QA 모듈 (일반의약품 LLM 질의응답)
└─ OCR 모듈 (처방약 텍스트 인식 → 스케줄 자동 등록)
↓
[Firebase FCM → Kotlin 안드로이드 앱]

yaml
코드 복사

---

## ✅ 역할 분담

| 구성 | 사용 기술 | 주요 역할 |
| --- | --- | --- |
| 라즈베리파이 | Python, HX711 드라이버, HTTP/MQTT | - 무게 측정·신호 전처리(EWMA)<br>- Django 서버로 전송 |
| 백엔드 서버 | Django + DRF, PostgreSQL, Redis, Celery | - 무게 기반 AI 판별<br>- OTC-QA 질의응답 (RAG)<br>- OCR 처방 파싱 → 복약 일정 생성<br>- 푸시 알림 전송 |
| 모바일 앱 | Kotlin(Compose), Retrofit, Room, FCM | - 복약 정보·스케줄 확인<br>- OTC-QA 질문 UI<br>- 알림 수신 및 기록 확인 |

---

## ✅ 🎯 AI 주요 기능

1. **무게 기반 복용 여부**  
   - 단순 감량 탐지 X → 패턴 학습  
   - `진짜 복용` vs `뚜껑 열림/노이즈` 구분  
   - 오탐 최소화, 정확한 기록 확보  

2. **미복용 확률 예측**  
   - 개인별 과거 기록 기반 확률 계산  
   - `"오늘 저녁 복용 놓칠 확률 = p(miss)"`  
   - 알림 강도·시간 조절 가능  

3. **개인화 알림 최적화**  
   - 평소 복용 시간/습관 학습  
   - 반응률 높은 시간대에 맞춰 알림 전송  

4. **OTC-QA (일반의약품 질의응답)**  
   - 데이터 소스: 식약처(e약은요), HIRA, 약학정보원  
   - 예: “타이레놀 최대 복용량?” → 출처와 함께 답변  
   - 안전 가드레일: 임산부, 소아, 중복성분 자동 경고  

5. **처방약 OCR 스케줄러**  
   - 처방전 사진 → OCR → 용법 파싱  
   - 예: `500mg 1정 1일 3회 5일간` → 자동 RRULE 생성  
   - 앱에서 스케줄 확인 및 알림 동기화  
   - 모호한 용법(“필요시”)은 사용자 확인 필수  

---

## ✅ 핵심 플로우

- **무게 변화 감지** → 복용 여부 판별 → 기록 저장  
- **OTC-QA 질의응답** → LLM + RAG 답변 + 출처 제공  
- **처방전 촬영** → OCR 인식 → 파싱 → 스케줄 자동 등록  
- **FCM 알림** → 사용자 복약 알림 + 보호자 공유  

---

## ✅ 실패·예외 처리

### 센서/라즈베리파이
- 무게 읽기 실패: 3회 재시도 후 로컬 큐 저장 → 재전송  
- 드리프트/영점 이탈: 자동 재영점화, 수동 캘리브레이션 지원  
- 스파이크 노이즈: EWMA + 중앙값 필터로 제거  

### 네트워크/전송
- HTTP 타임아웃 시 지수 백오프, 최대 5회  
- 장기 연결 불가 시 MQTT 폴백  
- 중복 전송 방지: event_id(UUID) 기반 UPSERT  

### 서버/API
- 입력 검증: 단위·타임존 강제  
- 트랜잭션: Regimen ↔ DoseEvent 원자적 처리  
- 인증: 디바이스 토큰 회전, 재사용 방지 nonce 검증  
- 작업 큐: Celery 재시도(지수+랜덤 지터), DLQ 격리  

### 알림/앱
- 무효 토큰: 즉시 제거  
- 알림 실패 시 사용자 앱 로컬 알림 폴백  
- OCR 실패: 대비/샤프닝 후 재시도, 최종적으로 사용자 수동 입력 유도  
- 모호한 용법(“필요시”) → 기본 비활성화 후 사용자 확인 요청  

---

## ✅ 주의사항
- 본 시스템은 **의학적 진단·처방을 대체하지 않음**  
- 의약품 관련 답변은 항상 **공식 데이터 출처**와 함께 제공  
- 개인 정보와 의료 데이터는 암호화 저장 및 일정 기간 후 파기  
